# Development Dockerfile with Composer
FROM ubuntu:24.04

WORKDIR /var/www

# Install PHP and development dependencies
RUN apt-get update && apt-get install -y \
    software-properties-common \
    && add-apt-repository ppa:ondrej/php -y \
    && apt-get update

RUN apt-get install -y \
    php8.3 \
    php8.3-fpm \
    php8.3-redis \
    php8.3-cli \
    php8.3-mysql \
    php8.3-mbstring \
    php8.3-zip \
    php8.3-intl \
    php8.3-bcmath \
    php8.3-opcache \
    php8.3-soap \
    php8.3-curl \
    php8.3-xml \
    php8.3-dev \
    php8.3-xdebug \
    curl \
    unzip \
    git \
    libzip-dev \
    libonig-dev \
    libxml2-dev \
    libicu-dev \
    netcat-openbsd \
    ca-certificates \
    gnupg \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20.x
RUN mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list && \
    apt-get update && \
    apt-get install -y nodejs && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Verify PHP extensions
RUN php -m | grep curl

# Create laravel user
RUN groupadd --system laravel && useradd --system --gid laravel laravel

# Configure PHP-FPM to run as laravel user
RUN mkdir -p /run/php /var/log && \
    touch /var/log/php8.3-fpm.log && \
    chown -R laravel:laravel /run/php /var/log/php8.3-fpm.log && \
    chmod 666 /var/log/php8.3-fpm.log

# Configure PHP-FPM
RUN sed -i 's/;daemonize = yes/daemonize = no/' /etc/php/8.3/fpm/php-fpm.conf && \
    sed -i 's/listen = .*/listen = 0.0.0.0:9000/' /etc/php/8.3/fpm/pool.d/www.conf && \
    sed -i 's/user = www-data/user = laravel/' /etc/php/8.3/fpm/pool.d/www.conf && \
    sed -i 's/group = www-data/group = laravel/' /etc/php/8.3/fpm/pool.d/www.conf && \
    sed -i 's|^;error_log = .*|error_log = /proc/self/fd/2|' /etc/php/8.3/fpm/php-fpm.conf && \
    sed -i 's|^error_log = .*|error_log = /proc/self/fd/2|' /etc/php/8.3/fpm/php-fpm.conf

COPY docker/php/php.ini /etc/php/8.3/fpm/conf.d/99-custom.ini
COPY docker/php/php.ini /etc/php/8.3/cli/conf.d/99-custom.ini

# Create all necessary storage directories
RUN mkdir -p /var/www/bootstrap/cache \
    /var/www/storage/framework/views \
    /var/www/storage/framework/sessions \
    /var/www/storage/framework/cache \
    /var/www/storage/logs \
    /var/www/storage/app/public

RUN chown -R laravel:laravel /var/www && \
    chmod -R 775 /var/www/bootstrap/cache /var/www/storage

COPY --chown=laravel:laravel docker/php/entrypoint-dev.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 9000

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
