#!/usr/bin/env bash

# Set proper user ID if WWWUSER is specified
if [ -n "$WWWUSER" ]; then
    usermod -u "$WWWUSER" app
fi

# Ensure composer directory exists with correct permissions
if [ ! -d /.composer ]; then
    mkdir -p /.composer
    chown -R app:app /.composer
    chmod -R 775 /.composer  # More secure than ugo+rw
fi

# Set permissions for web directory
if [ -d /var/www/html ]; then
    chown -R app:app /var/www/html

    # Set directory and file permissions separately
    find /var/www/html -type d -exec chmod 755 {} \;  # drwxr-xr-x
    find /var/www/html -type f -exec chmod 644 {} \;  # -rw-r--r--

    # Special permissions for storage and bootstrap/cache
    if [ -d /var/www/html/storage ]; then
        chmod -R 775 /var/www/html/storage
    fi

    if [ -d /var/www/html/bootstrap/cache ]; then
        chmod -R 775 /var/www/html/bootstrap/cache
    fi
fi

# Execute commands as app user or start supervisor
if [ $# -gt 0 ]; then
    exec gosu "$WWWUSER" "$@"
else
    # Start supervisor for process management
    exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
fi
